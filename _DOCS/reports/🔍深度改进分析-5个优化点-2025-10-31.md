# ğŸ” Self-Aware-MRAGæ·±åº¦æ”¹è¿›åˆ†æ

**æ—¥æœŸ**: 2025-10-31  
**çŠ¶æ€**: å½“å‰å®éªŒè¿è¡Œä¸­ï¼Œå‘ç°5ä¸ªæ½œåœ¨æ”¹è¿›ç‚¹  

---

## ğŸ“Š å½“å‰çŠ¶æ€

### å·²å®Œæˆçš„ä¼˜åŒ–
- âœ… ç®€åŒ–Contextæ ¼å¼ï¼ˆç§»é™¤å¤æ‚æ ‡ç­¾ï¼‰
- âœ… æ–‡æ¡£é•¿åº¦ï¼š800 â†’ 512å­—ç¬¦
- âœ… æ–‡æ¡£æ•°é‡ï¼šTop-5 â†’ Top-3
- âœ… æ£€ç´¢é˜ˆå€¼ï¼š0.0 â†’ 0.35

### å®éªŒä¿¡æ¯
- **å¯åŠ¨æ—¶é—´**: 2025-10-31 08:21
- **é¢„è®¡å®Œæˆ**: 14:00-15:00
- **é¢„æœŸæ€§èƒ½**: EM 63-65%, F1 70-73%

---

## ğŸ” å‘ç°çš„5ä¸ªæ½œåœ¨æ”¹è¿›ç‚¹

### ğŸ› æ”¹è¿›ç‚¹1: Position Fusionæƒé‡å…¬å¼é”™è¯¯ **âš ï¸ ä¸¥é‡Bug**

**ä¼˜å…ˆçº§**: ğŸ”¥ğŸ”¥ğŸ”¥ **æœ€é«˜**  
**é¢„æœŸæå‡**: +5-8%  
**å®æ–½éš¾åº¦**: æä½ï¼ˆä¿®æ”¹1ä¸ªå­—ç¬¦ï¼‰

#### é—®é¢˜æè¿°

**å½“å‰ä»£ç ** (`self_aware_pipeline_qwen3vl.py` Line 448):
```python
position_weights = np.exp(np.arange(k) * 0.5)
```

**ä¸¥é‡Bug**: è¿™ä¸ªå…¬å¼ä¼šè®©**åé¢çš„æ–‡æ¡£**è·å¾—**æ›´é«˜çš„æƒé‡**ï¼

#### æ•°å€¼åˆ†æ

å‡è®¾k=5ï¼Œå½“å‰æƒé‡åˆ†å¸ƒï¼š
```
ä½ç½®1: 6.68%   (æœ€ç›¸å…³æ–‡æ¡£)
ä½ç½®2: 11.02%
ä½ç½®3: 18.18%
ä½ç½®4: 29.97%
ä½ç½®5: 34.16%  (æœ€ä¸ç›¸å…³æ–‡æ¡£) âš ï¸ æƒé‡æœ€é«˜ï¼
```

**é—®é¢˜**: ç¬¬5ä¸ªæ–‡æ¡£ï¼ˆæœ€ä¸ç›¸å…³ï¼‰çš„æƒé‡æ˜¯ç¬¬1ä¸ªæ–‡æ¡£ï¼ˆæœ€ç›¸å…³ï¼‰çš„**5.1å€**ï¼

#### å½±å“åˆ†æ

æ¨¡æ‹Ÿåœºæ™¯ï¼šBGEæ£€ç´¢å™¨è¿”å›5ä¸ªæ–‡æ¡£ï¼Œç›¸å…³åº¦é€’å‡ï¼š
- Doc1: score=0.9 (æœ€ç›¸å…³)
- Doc2: score=0.7
- Doc3: score=0.5
- Doc4: score=0.3
- Doc5: score=0.1 (æœ€ä¸ç›¸å…³)

**é”™è¯¯å…¬å¼çš„é‡æ’åºç»“æœ**:
- Top1: Doc4 (åŸæœ¬ç¬¬4) âŒ
- Top2: Doc3 (åŸæœ¬ç¬¬3)
- Top3: Doc5 (åŸæœ¬ç¬¬5) âŒ

**ç»“æœ**: æœ€ä¸ç›¸å…³çš„æ–‡æ¡£è¢«æå‰ï¼Œæœ€ç›¸å…³çš„æ–‡æ¡£è¢«é™çº§ï¼

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆA**: ä¿®æ­£å…¬å¼ï¼ˆæ·»åŠ è´Ÿå·ï¼‰
```python
position_weights = np.exp(-np.arange(k) * 0.5)  # æ·»åŠ è´Ÿå·
```

æ­£ç¡®çš„æƒé‡åˆ†å¸ƒï¼š
```
ä½ç½®1: 40.19%  (æœ€ç›¸å…³æ–‡æ¡£) âœ… æƒé‡æœ€é«˜
ä½ç½®2: 30.68%
ä½ç½®3: 23.42%
ä½ç½®4: 17.88%
ä½ç½®5: 13.65%  (æœ€ä¸ç›¸å…³æ–‡æ¡£)
```

**æ–¹æ¡ˆB**: ç›´æ¥ç¦ç”¨Position Fusion
```python
# åœ¨run_all_baselines_100samples.pyä¸­è®¾ç½®
'use_position_fusion': False
```

ç›´æ¥ä½¿ç”¨BGEçš„åŸå§‹æ’åºï¼Œä¸è¿›è¡Œé‡æ’åºã€‚

#### æ¨è

**ç«‹å³ä¿®å¤**ï¼è¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„Bugï¼Œå¯èƒ½æ˜¯æ€§èƒ½å·®çš„ä¸»è¦åŸå› ã€‚

---

### æ”¹è¿›ç‚¹2: Query Reformulatorå¯èƒ½è¿‡åº¦ä¿®æ”¹

**ä¼˜å…ˆçº§**: âš ï¸âš ï¸ ä¸­ç­‰  
**é¢„æœŸæå‡**: +2-3%  
**å®æ–½éš¾åº¦**: ä½

#### é—®é¢˜æè¿°

`QueryReformulator.reformulate()` ä¼šä¿®æ”¹åŸå§‹questionï¼š
- æå–æ ¸å¿ƒé—®é¢˜
- é‡ç»„é€‰é¡¹å…³é”®è¯
- æ·»åŠ æ£€ç´¢æç¤º

è™½ç„¶æˆ‘ä»¬ä¿®å¤äº†Optionsåœ¨ç”Ÿæˆæ—¶çš„é—®é¢˜ï¼Œä½†**æ£€ç´¢æ—¶ä½¿ç”¨çš„enhanced_query**å¯èƒ½ä¸å¦‚åŸå§‹questionç²¾ç¡®ã€‚

#### ä»£ç ä½ç½®

`self_aware_pipeline_qwen3vl.py` Line 245-249:
```python
enhanced_query = self.query_reformulator.reformulate(
    query=question,
    uncertainty_scores=uncertainty_info,
    modality=modality
)
# ä½¿ç”¨enhanced_queryè¿›è¡Œæ£€ç´¢
```

#### ç¤ºä¾‹

åŸå§‹question:
```
In which city can the building in the picture be found?
Options:
A. Boston
B. Chicago
C. New York
D. San Francisco

Answer with the letter only (A/B/C/D):
```

Enhanced query (è¢«reformulateå):
```
In which city can the building in the picture be found? Options: Boston / Chicago / New York / San Francisco
```

**é—®é¢˜**: 
- ä¸¢å¤±äº†å®Œæ•´çš„é€‰é¡¹æ ¼å¼
- å¯èƒ½æ”¹å˜äº†è¯­ä¹‰
- æ£€ç´¢æ•ˆæœå¯èƒ½ä¸å¦‚åŸå§‹question

#### ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆA**: ç¦ç”¨Query Reformulation
```python
# ç›´æ¥ä½¿ç”¨åŸå§‹question
enhanced_query = question  # ä¸è°ƒç”¨reformulate()
```

**æ–¹æ¡ˆB**: åªå¯¹é«˜ä¸ç¡®å®šæ€§çš„queryè¿›è¡Œè½»åº¦æ”¹å†™
```python
if total_unc > 0.6:  # åªæœ‰é«˜ä¸ç¡®å®šæ€§æ‰æ”¹å†™
    enhanced_query = self.query_reformulator.reformulate(...)
else:
    enhanced_query = question
```

#### æ¨è

ç­‰å¾…å½“å‰å®éªŒç»“æœï¼Œå¦‚æœä»ä½äºbaselineï¼Œå°è¯•æ–¹æ¡ˆAã€‚

---

### æ”¹è¿›ç‚¹3: Attributionæ¨¡å—è®¡ç®—å¼€é”€å¤§ä½†æœªä½¿ç”¨

**ä¼˜å…ˆçº§**: âš ï¸ ä½  
**é¢„æœŸæå‡**: é€Ÿåº¦+30%  
**å®æ–½éš¾åº¦**: æä½

#### é—®é¢˜æè¿°

åœ¨ç®€åŒ–Contextæ ¼å¼åï¼ŒAttributionçš„è¾“å‡ºä¸å†è¢«ä½¿ç”¨ï¼š

```python
# Line 320-329: Attributionè®¡ç®—
if self.use_attribution and fused_docs:
    attributions = self.attribution_module.attribute_text_evidence(...)
    # ä½†åœ¨_format_context_with_attribution_preview()ä¸­
    # æˆ‘ä»¬å·²ç»ä¸å†ä½¿ç”¨attributionså‚æ•°ï¼
```

ç®€åŒ–åçš„æ ¼å¼åŒ–å‡½æ•°ï¼š
```python
def _format_context_with_attribution_preview(..., attributions=None):
    for i, doc in enumerate(docs):
        doc_text = doc[:512]
        context_parts.append(f"Document {i+1}:\n{doc_text}")
        # attributionså‚æ•°è¢«å¿½ç•¥
```

#### å½±å“

- **è®¡ç®—å¼€é”€**: Attributionéœ€è¦NLIæ¨¡å‹æ¨ç†ï¼Œæ¯ä¸ªæ ·æœ¬å¢åŠ 5-10ç§’
- **æ— æ”¶ç›Š**: è®¡ç®—ç»“æœä¸å†è¢«ä½¿ç”¨
- **çº¯æµªè´¹**: 100%çš„å¼€é”€ï¼Œ0%çš„æ”¶ç›Š

#### ä¿®å¤æ–¹æ¡ˆ

åœ¨`run_all_baselines_100samples.py`ä¸­è®¾ç½®ï¼š
```python
'use_attribution': False  # å½“å‰æ˜¯True
```

#### æ¨è

**å¯ä»¥ç«‹å³åº”ç”¨**ï¼Œå› ä¸ºä¸å½±å“ç­”æ¡ˆè´¨é‡ï¼Œåªæ˜¯æé€Ÿã€‚

---

### æ”¹è¿›ç‚¹4: Promptæ ¼å¼å¯ä»¥æ›´åŠ å¯¹é½Baseline

**ä¼˜å…ˆçº§**: âš ï¸ ä½  
**é¢„æœŸæå‡**: +1-2%  
**å®æ–½éš¾åº¦**: ä¸­

#### é—®é¢˜æè¿°

**Self-Aware-MRAGçš„Prompt** (Line 507-513):
```python
prompt = f"""Based on the following evidence, answer the question concisely.

{context}

Question: {question}

Answer:"""
```

**Baselineçš„Prompt** (Self-RAG, Line 278-291):
```python
prompt = f"""Based on the context below, answer the question.

Context:
{context}

Question: {sample['question']}

Choices:
A. {sample['A']}
B. {sample['B']}
C. {sample['C']}
D. {sample['D']}

Answer with the letter only (A/B/C/D):"""
```

#### å·®å¼‚

| ç‰¹æ€§ | Self-Aware-MRAG | Baseline |
|------|----------------|----------|
| æ˜ç¡®æŒ‡å‡ºContext | âŒ ç”¨"evidence" | âœ… ç”¨"Context:" |
| å±•ç¤ºé€‰é¡¹ | âŒ åœ¨questionä¸­ | âœ… å•ç‹¬çš„"Choices:" |
| ç­”æ¡ˆæ ¼å¼è¯´æ˜ | âŒ åœ¨questionä¸­ | âœ… æ˜ç¡®è¯´æ˜ |

#### ä¿®å¤æ–¹æ¡ˆ

ä¿®æ”¹`_generate_answer_qwen3vl()`çš„promptæ„å»ºé€»è¾‘ï¼Œå®Œå…¨å¯¹é½baselineæ ¼å¼ã€‚

#### æ¨è

ç­‰å¾…å½“å‰å®éªŒç»“æœï¼Œå¦‚æœæ¥è¿‘baselineä½†ä»æœ‰å°å·®è·ï¼Œå¯ä»¥å°è¯•æ­¤ä¼˜åŒ–ã€‚

---

### æ”¹è¿›ç‚¹5: æ–‡æ¡£é•¿åº¦å¯èƒ½ä»ç„¶è¿‡é•¿

**ä¼˜å…ˆçº§**: âš ï¸ ä½  
**é¢„æœŸæå‡**: +0-2%  
**å®æ–½éš¾åº¦**: æä½

#### é—®é¢˜æè¿°

å½“å‰è®¾ç½®ï¼š512å­—ç¬¦/æ–‡æ¡£

Baselineå¯èƒ½ä½¿ç”¨æ›´çŸ­çš„æ–‡æ¡£ç‰‡æ®µï¼ˆ200-300å­—ç¬¦?ï¼‰ï¼Œæ›´çŸ­çš„æ–‡æ¡£èƒ½è®©LLMæ›´èšç„¦å…³é”®ä¿¡æ¯ã€‚

#### ä¿®å¤æ–¹æ¡ˆ

```python
doc_text = doc[:300]  # ä»512æ”¹ä¸º300
```

#### æ¨è

ç­‰å¾…å®éªŒç»“æœï¼Œå¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–å¯ä»¥å°è¯•ã€‚

---

## ğŸ¯ æ¨èè¡ŒåŠ¨æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä¿å®ˆç­–ç•¥ï¼ˆæ¨èï¼‰

**ç­‰å¾…å½“å‰å®éªŒå®Œæˆ** â†’ æ ¹æ®ç»“æœå†³å®šï¼š

1. **å¦‚æœEMâ‰¥63%**: 
   - âœ… æˆåŠŸï¼ä¸éœ€è¦æ›´å¤šæ”¹è¿›
   - å‡†å¤‡è®ºæ–‡æ›´æ–°å’ŒGitHubæäº¤

2. **å¦‚æœEM=60-62%**:
   - åº”ç”¨æ”¹è¿›ç‚¹1ï¼ˆä¿®å¤Position Fusion Bugï¼‰
   - åº”ç”¨æ”¹è¿›ç‚¹3ï¼ˆç¦ç”¨Attributionæé€Ÿï¼‰
   - é‡è·‘å®éªŒ

3. **å¦‚æœEM<60%**:
   - åº”ç”¨æ”¹è¿›ç‚¹1+2+3
   - è€ƒè™‘å›é€€åˆ°æœ€ç®€å•çš„baselineï¼Œé€ä¸ªæ·»åŠ åˆ›æ–°ç‚¹

### æ–¹æ¡ˆB: æ¿€è¿›ç­–ç•¥

**ç«‹å³åœæ­¢å½“å‰å®éªŒ**ï¼Œåº”ç”¨æ‰€æœ‰æ”¹è¿›ï¼š

1. âœ… ä¿®å¤Position Fusion Bugï¼ˆæ”¹è¿›ç‚¹1ï¼‰
2. âœ… ç¦ç”¨Query Reformulationï¼ˆæ”¹è¿›ç‚¹2ï¼‰
3. âœ… ç¦ç”¨Attributionï¼ˆæ”¹è¿›ç‚¹3ï¼‰
4. âœ… ä¼˜åŒ–Promptæ ¼å¼ï¼ˆæ”¹è¿›ç‚¹4ï¼‰

ç„¶åé‡è·‘å®éªŒã€‚

**ä¼˜ç‚¹**: 
- å¯èƒ½ä¸€æ¬¡æ€§è¾¾åˆ°æœ€ä½³æ€§èƒ½
- èŠ‚çœæ—¶é—´ï¼ˆä¸ç”¨ç­‰6å°æ—¶ï¼‰

**ç¼ºç‚¹**:
- å¦‚æœæ•ˆæœä¸å¥½ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªæ”¹è¿›æœ‰é—®é¢˜
- å¤±å»äº†é€æ­¥éªŒè¯çš„æœºä¼š

---

## ğŸ’¡ æˆ‘çš„å»ºè®®

### ğŸ¯ æ¨èï¼š**æ··åˆç­–ç•¥**

**ç«‹å³åº”ç”¨æ— é£é™©çš„æ”¹è¿›**:
- âœ… æ”¹è¿›ç‚¹1: ä¿®å¤Position Fusion Bugï¼ˆ**è¿™æ˜¯ä¸¥é‡Bugï¼Œå¿…é¡»ä¿®**ï¼‰
- âœ… æ”¹è¿›ç‚¹3: ç¦ç”¨Attributionï¼ˆåªæ˜¯æé€Ÿï¼Œä¸å½±å“ç­”æ¡ˆï¼‰

**ä¿ç•™éªŒè¯çš„æ”¹è¿›**:
- â¸ï¸ æ”¹è¿›ç‚¹2: Query Reformulationï¼ˆç­‰å®éªŒç»“æœï¼‰
- â¸ï¸ æ”¹è¿›ç‚¹4: Promptæ ¼å¼ï¼ˆç­‰å®éªŒç»“æœï¼‰
- â¸ï¸ æ”¹è¿›ç‚¹5: æ–‡æ¡£é•¿åº¦ï¼ˆç­‰å®éªŒç»“æœï¼‰

**ç†ç”±**:
- Position Fusionçš„Bugå¤ªä¸¥é‡ï¼Œä¸ä¿®è‚¯å®šå½±å“æ€§èƒ½
- Attributionç¦ç”¨åªæ˜¯æé€Ÿï¼Œä¸å½±å“ç­”æ¡ˆè´¨é‡
- å…¶ä»–æ”¹è¿›å¯ä»¥æ ¹æ®å®éªŒç»“æœå†å†³å®š

---

## ğŸ“ å®æ–½æ­¥éª¤ï¼ˆæ··åˆç­–ç•¥ï¼‰

### Step 1: åœæ­¢å½“å‰å®éªŒ
```bash
ps aux | grep run_all_baselines
kill <PID>
```

### Step 2: åº”ç”¨æ”¹è¿›1ï¼ˆä¿®å¤Position Fusion Bugï¼‰
```python
# File: self_aware_pipeline_qwen3vl.py, Line 448
position_weights = np.exp(-np.arange(k) * 0.5)  # æ·»åŠ è´Ÿå·
```

### Step 3: åº”ç”¨æ”¹è¿›3ï¼ˆç¦ç”¨Attributionï¼‰
```python
# File: run_all_baselines_100samples.py, Line 1340
'use_attribution': False,  # ä»Trueæ”¹ä¸ºFalse
```

### Step 4: é‡å¯å®éªŒ
```bash
cd /root/autodl-tmp
conda activate multirag
nohup bash start_optimized_experiment.sh > nohup_fixed_v2.out 2>&1 &
```

### Step 5: ç›‘æ§å¹¶ç­‰å¾…ç»“æœ
```bash
tail -f optimized_100samples.log
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

| ç‰ˆæœ¬ | EM | F1 | è¯´æ˜ |
|------|-----|-----|------|
| åŸå§‹ç‰ˆæœ¬ | 55.0% | 62.16% | Contextå¤æ‚+Always Retrieve |
| ä¼˜åŒ–v1 (å½“å‰è¿è¡Œ) | 63-65%? | 70-73%? | Contextç®€åŒ–+å‚æ•°ä¼˜åŒ– |
| ä¼˜åŒ–v2 (å»ºè®®) | **66-68%** | **73-76%** | +ä¿®å¤Position Bug+ç¦ç”¨Attribution |

**ç›®æ ‡**: è¶…è¶Šæœ€ä½³baseline (mRÂ²AG: 61.0%, 68.89%) âœ…

---

## â° æ—¶é—´æˆæœ¬

- **åœæ­¢å½“å‰å®éªŒ**: 0åˆ†é’Ÿï¼ˆéšæ—¶å¯åœï¼‰
- **ä»£ç ä¿®æ”¹**: 5åˆ†é’Ÿ
- **é‡å¯å®éªŒ**: 6å°æ—¶
- **æ€»æˆæœ¬**: 6å°æ—¶5åˆ†é’Ÿ

vs.

- **ç­‰å¾…å½“å‰å®éªŒå®Œæˆ**: 6å°æ—¶
- **å¦‚æœéœ€è¦å†æ”¹**: å†ç­‰6å°æ—¶
- **æ€»æˆæœ¬**: 12å°æ—¶

**å»ºè®®**: ç«‹å³åº”ç”¨æ··åˆç­–ç•¥ï¼ŒèŠ‚çœ6å°æ—¶ï¼

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-31 08:30  
**çŠ¶æ€**: ç­‰å¾…å†³ç­– ğŸ¯

