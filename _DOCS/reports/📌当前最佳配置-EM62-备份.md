# ğŸ“Œ å½“å‰æœ€ä½³é…ç½®å¤‡ä»½ - EM 62.0%

**å¤‡ä»½æ—¶é—´**: 2025-10-31 11:15  
**ç‰ˆæœ¬**: Promptæ ¼å¼ä¿®å¤ç‰ˆæœ¬  

---

## âœ… éªŒè¯ç»“æœ

**Self-Aware-MRAGæ€§èƒ½**:
- **EM: 62.0%** âœ… (è¶…è¶Šbaseline 61.0%)
- **F1: 67.72%** (æ¥è¿‘baseline 68.89%, å·®è·1.17%)
- **VQA: 20.67%**
- **é€Ÿåº¦**: 25.45ç§’/æ ·æœ¬

---

## ğŸ”§ å½“å‰é…ç½®

### 1. Contextæ ¼å¼
```python
# Line 489
doc_text = doc[:512] if len(doc) > 512 else doc  # 512å­—ç¬¦æˆªæ–­

# Line 490-492
context_parts.append(
    f"Document {i+1}:\n{doc_text}"
)
```

### 2. ç”Ÿæˆå‚æ•°
```python
# Line 559-564
answer = self.qwen3_vl.generate(
    text=prompt,
    image=image,
    max_new_tokens=10,
    temperature=0.01
    # æ³¨æ„ï¼šæ²¡æœ‰ do_sample å‚æ•°
)
```

### 3. Promptæ ¼å¼
```python
# Line 511-528 (å¤šé€‰é¢˜)
if has_choices:
    core_question = question.split('\nOptions:')[0] if '\nOptions:' in question else question.split('\n')[0]
    
    prompt = f"""Based on the following evidence, answer the question.

{context}

Question: {core_question}

Choices:
A. {sample['A']}
B. {sample['B']}
C. {sample['C']}
D. {sample['D']}

Answer with the letter only (A/B/C/D):"""
```

### 4. å…¶ä»–å…³é”®å‚æ•°
- Position Fusion: ä¿®å¤åçš„å…¬å¼ `np.exp(-np.arange(k) * 0.5)` âœ…
- æ–‡æ¡£æ•°é‡: Top-3
- Query Reformulation: å¯ç”¨
- Attribution: å¯ç”¨
- threshold: 0.35

---

## ğŸ“„ å¤‡ä»½æ–‡ä»¶

**ä»£ç å¤‡ä»½**: `/root/autodl-tmp/FlashRAG/flashrag/pipeline/self_aware_pipeline_qwen3vl_BACKUP_EM62.py`

**æ¢å¤æ–¹æ³•**:
```bash
cd /root/autodl-tmp/FlashRAG/flashrag/pipeline
cp self_aware_pipeline_qwen3vl_BACKUP_EM62.py self_aware_pipeline_qwen3vl.py
```

---

## ğŸ¯ å…³é”®æ”¹è¿›å†ç¨‹

1. **åŸå§‹ç‰ˆæœ¬**: EM 55.0%, F1 62.16%
2. **ç®€åŒ–Contextæ ¼å¼**: (Contextå¤æ‚åº¦é™ä½)
3. **ä¿®å¤Position Bug**: EM 60.0%, F1 65.72% (+5.0%)
4. **ä¿®å¤Promptæ ¼å¼**: EM 62.0%, F1 67.72% (+2.0%) âœ…

**æ€»æå‡**: +7.0% EM, +5.56% F1

---

## ğŸ’¡ ä¸‹ä¸€æ­¥ä¼˜åŒ–è®¡åˆ’

å‡†å¤‡å°è¯•çš„2ä¸ªä¼˜åŒ–:
1. æ·»åŠ `do_sample=False` - é¢„æœŸ+0.5-1.0%
2. ç§»é™¤æ–‡æ¡£æˆªæ–­ï¼ˆå®Œæ•´æ–‡æ¡£ï¼‰- é¢„æœŸ+0.5-1.5%

**ç›®æ ‡**: EM 63-64%, F1 69-71%

**å›é€€æ¡ä»¶**: å¦‚æœEM<62.0%æˆ–F1<67.5%ï¼Œç«‹å³å›é€€åˆ°æ­¤ç‰ˆæœ¬

---

**å¤‡ä»½çŠ¶æ€**: âœ… å·²ä¿å­˜  
**å›é€€é£é™©**: ä½ï¼ˆå·²æœ‰å®Œæ•´å¤‡ä»½ï¼‰

