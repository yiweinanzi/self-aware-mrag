# ⚠️ 项目手册 - 重要信息 【不能删除 / 不能归档】

**最后更新**: 2025-10-31 23:35  
**重要级别**: ⭐⭐⭐⭐⭐  
**GitHub仓库**: https://github.com/yiweinanzi/self-aware-mrag

**🔥 最新变更 (2025-10-31)**:
- ✅ 切换到CrossModalUncertaintyEstimator（论文完整实现）
- ✅ 使用Gram矩阵 + eigen_score + JS散度（代替简化版）
- ✅ 根目录清理完成，文档已归档到 `_DOCS/`
- 🔄 全数据集实验重新启动（使用论文完整实现）

**📋 快速导航**:
- [必读规则](#-必读规则)
- [核心问题修正](#1-核心问题修正-2025-10-31)
- [语料库和索引位置](#2-语料库和索引位置不要编造)
- [核心代码位置](#3-核心代码位置索引-)
- [文档归档说明](#4-文档归档说明-new)
- [最新实验进度](#5-最新实验进度)

---

## 1. 核心问题修正 (2025-10-31)

### ⚠️ 发现并修复的关键问题

**问题**：实验使用了错误的不确定性估计器，导致性能下降

| 版本 | U_text | U_visual | U_align | 100样本EM | 1353样本EM |
|------|--------|----------|---------|-----------|------------|
| **ImprovedUncertaintyEstimator** (简化版) | 关键词匹配 | CLIP特征 | CLIP相似度 | 62.0% | 48.7% ❌ |
| **CrossModalUncertaintyEstimator** (论文完整实现) | Gram矩阵+eigen_score | Attention variance | JS散度 | 预计63-65% | 预计55-60% ✅ |

**修改记录**：
- 修改文件：`FlashRAG/experiments/run_all_baselines_100samples.py`
- 修改内容：`'use_improved_estimator': False`
- 备份位置：`_BACKUP_ImprovedEstimator_2025-10-31/`
- 详细文档：`_DOCS/reports/📝修改记录-切换到完整实现.md`

---

## 2. 语料库和索引位置（不要编造！）

### **当前真实路径（2025-10-30更新）**

**⚠️ 重要变更：已改用纯Wikipedia 300万语料库**

**当前语料库**:
```
路径: /root/autodl-tmp/FlashRAG/corpus/corpus_wiki_3m.jsonl
大小: ~1.5GB
文档数: 3,000,000
来源: 100% Wikipedia (取前300万条)
构建脚本: FlashRAG/tools/build_corpus_wiki_only_3m.py
```

**当前索引**:
```
目录: /root/autodl-tmp/FlashRAG/indexes/wiki_3m/bge/
├── e5_Flat.index       # BGE文本索引 (已构建完成)
└── emb_e5.memmap       # 嵌入向量
构建脚本: FlashRAG/tools/rebuild_index_wiki_3m.py
```

**原始数据**:
```
Wikipedia TSV: /root/autodl-tmp/data/wikipedia/psgs_w100.tsv
  - 大小: 13GB
  - 总文档数: 21,015,325 条
  - 使用: 前 3,000,000 条
```

**⚠️ 已废弃（不要使用）**:
- ❌ `corpus/corpus_3m_real.jsonl` (混合语料库) 
- ❌ `indexes/3m_real/` (混合语料库索引)
- ❌ CC3M相关文件（因磁盘空间不足已取消）

---

## 3. 核心代码位置（索引） 🔍

### 3.1 Self-Aware-MRAG (Our Method)

**主要Pipeline**:
```
/root/autodl-tmp/FlashRAG/flashrag/pipeline/self_aware_pipeline_qwen3vl.py
```
- 核心创新：跨模态不确定性 + 自适应检索 + 位置融合
- 使用模型：Qwen3-VL-8B-Instruct
- 当前配置：使用CrossModalUncertaintyEstimator（论文完整实现）

**核心模块**:
```
/root/autodl-tmp/FlashRAG/flashrag/modules/
├── uncertainty_estimator.py              # ✅ CrossModalUncertaintyEstimator（论文完整实现）
├── uncertainty_estimator_improved.py     # ⚠️ ImprovedUncertaintyEstimator（简化版，已弃用）
├── position_aware_fusion.py              # 位置感知融合
├── attribution.py                        # 细粒度归因
├── qwen3_vl.py                          # Qwen3-VL封装
└── query_reformulator.py                 # 查询增强
```

### 3.2 Baseline方法（7个对比方法）

**Baseline实现位置**:
```
/root/autodl-tmp/FlashRAG/experiments/baselines/
├── selfrag_enhanced.py      # Self-RAG (Adaptive Retrieval + Reflection)
├── mr2ag_enhanced.py        # mR²AG (Multi-Round + Hierarchical)
├── visrag_enhanced.py       # VisRAG (BGE Reranker)
├── reveal_enhanced.py       # REVEAL (Two-stage Reasoning)
├── murag_enhanced.py        # MuRAG (FiD Parallel + Voting)
└── ragvl_enhanced.py        # RagVL (MLLM Reranker)
```

**说明**：所有baseline已按照原论文完整实现

### 3.3 实验脚本

**主实验脚本**:
```
/root/autodl-tmp/FlashRAG/experiments/run_all_baselines_100samples.py
```
- 7个方法对比实验
- 支持100样本或全数据集（1353样本）
- 7个核心评测指标

---

## 4. 文档归档说明 (NEW)

### 归档目录结构

```
/root/autodl-tmp/
├── README.md                                   # 项目介绍
├── ⚠️项目手册-重要信息-不能删除.md              # 本手册（重要！）
├── full_dataset_CrossModal_experiment.log     # 当前实验日志
│
├── _DOCS/                                     # 📚 文档归档目录
│   ├── README.md                              # 归档说明
│   ├── reports/                               # 📊 分析报告
│   │   ├── ✅论文实现完整性检查报告.md
│   │   ├── ⚠️全数据集性能下降分析.md
│   │   ├── 📝修改记录-切换到完整实现.md
│   │   └── ... (其他报告)
│   ├── scripts/                               # 🔧 测试脚本
│   │   ├── monitor_full_experiment.sh
│   │   ├── test_all_7methods_10samples.py
│   │   └── ... (其他脚本)
│   └── logs/                                  # 📝 旧实验日志
│       ├── run_100samples_*.log
│       └── ... (其他日志)
│
└── _BACKUP_ImprovedEstimator_2025-10-31/      # 💾 备份目录
    ├── README.md                               # 备份说明
    ├── run_all_baselines_100samples.py.backup
    ├── self_aware_pipeline_qwen3vl.py.backup
    └── full_dataset_experiment_ImprovedEst.log
```

### 归档原则

1. **根目录**: 只保留活跃的实验日志和重要手册
2. **_DOCS/reports/**: 已完成的分析报告
3. **_DOCS/scripts/**: 临时测试脚本
4. **_DOCS/logs/**: 已完成的实验日志
5. **_BACKUP_*/**: 代码备份和对应的实验结果

---

## 5. 最新实验进度

### 5.1 当前实验 (2025-10-31 23:03 启动)

**配置**:
- 数据集：MRAG-Bench 全数据集（1353样本）
- 方法：Self-Aware-MRAG + 6个baseline
- 不确定性估计器：**CrossModalUncertaintyEstimator**（论文完整实现）✅

**日志**:
```bash
tail -f /root/autodl-tmp/full_dataset_CrossModal_experiment.log
```

**预计时间**:
- Self-Aware-MRAG: ~12.4小时
- 全部7个方法: ~96小时（约4天）

**预期结果**:
- Self-Aware-MRAG EM: 55-60%（vs 之前48.7%，预计提升+6-11%）
- 基于论文完整实现的Gram矩阵 + eigen_score + JS散度

### 5.2 历史实验记录

| 实验 | 估计器 | 100样本EM | 1353样本EM | 状态 |
|------|--------|-----------|------------|------|
| 第一轮 | ImprovedUncertaintyEstimator | 62.0% | 48.7% | ❌ 性能下降 |
| 第二轮 | CrossModalUncertaintyEstimator | 预计63-65% | 预计55-60% | 🔄 进行中 |

**备份位置**: `/root/autodl-tmp/_BACKUP_ImprovedEstimator_2025-10-31/`

---

## 6. 论文关键创新实现状态

### 创新1: 跨模态不确定性感知 ✅

| 组件 | 论文要求 | CrossModalUncertaintyEstimator | 实现状态 |
|------|---------|-------------------------------|---------|
| U_text | Gram矩阵 + eigen_score | ✅ Line 427-460 | ✅ 完整实现 |
| U_visual | Attention variance | ✅ Line 236-272 | ✅ 完整实现 |
| U_align | JS散度 | ✅ Line 274-309, 493-525 | ✅ 完整实现 |

**文件位置**: 
```
/root/autodl-tmp/FlashRAG/flashrag/modules/uncertainty_estimator.py
```

### 创新2: 不确定性驱动的自适应检索 ✅

- ✅ 输入三种不确定性分数
- ✅ 输出检索策略（不检索/文本/图像/both）
- ✅ 减少30%+无效检索（实际达到34.6%-40%）

### 创新3: 位置去偏的证据融合 ⚠️

- ✅ 位置加权思想
- ⚠️ 简单排序（未实现U型重排序）

---

## 7. 必读规则

### 7.1 运行代码必须使用conda环境

```bash
# ❌ 错误
python experiments/xxx.py

# ✅ 正确
conda activate multirag && python experiments/xxx.py
```

**环境名称**: `multirag`  
**包含**: torch, transformers, datasets, faiss, flashrag等

### 7.2 查看实验进度

```bash
# 实时查看日志
tail -f /root/autodl-tmp/full_dataset_CrossModal_experiment.log

# 查看进度（使用监控脚本）
/root/autodl-tmp/monitor_full_experiment.sh

# 查看估计器类型
grep "使用.*不确定性估计器" /root/autodl-tmp/full_dataset_CrossModal_experiment.log
```

### 7.3 关键配置参数

**不确定性估计器**:
```python
# 论文完整实现（当前使用）
'use_improved_estimator': False  # CrossModalUncertaintyEstimator

# 简化版（已弃用）
'use_improved_estimator': True   # ImprovedUncertaintyEstimator
```

**其他核心参数**:
```python
'uncertainty_threshold': 0.35      # 不确定性阈值
'use_position_fusion': True        # 位置感知融合
'use_attribution': True            # 细粒度归因
'retrieval_topk': 5               # 检索Top-K
```

---

## 8. 重要链接和资源

**GitHub仓库**: https://github.com/yiweinanzi/self-aware-mrag

**关键文档**:
- 论文实现检查：`_DOCS/reports/✅论文实现完整性检查报告.md`
- 修改记录：`_DOCS/reports/📝修改记录-切换到完整实现.md`
- 性能分析：`_DOCS/reports/⚠️全数据集性能下降分析.md`

**备份和恢复**:
```bash
# 查看备份
ls /root/autodl-tmp/_BACKUP_ImprovedEstimator_2025-10-31/

# 恢复到简化版（不推荐）
cp /root/autodl-tmp/_BACKUP_ImprovedEstimator_2025-10-31/run_all_baselines_100samples.py.backup \
   /root/autodl-tmp/FlashRAG/experiments/run_all_baselines_100samples.py
```

---

## 9. 常见问题 (FAQ)

**Q: 为什么性能从62%降到48.7%？**
A: 使用了错误的ImprovedUncertaintyEstimator（关键词匹配），在大规模数据上误判率高。已切换到CrossModalUncertaintyEstimator（论文完整实现）。

**Q: 如何验证使用的是哪个估计器？**
A: 查看日志：
```bash
grep "使用.*不确定性估计器" full_dataset_CrossModal_experiment.log
# 应该看到：✅ 使用原始不确定性估计器 (CrossModalUncertaintyEstimator)
```

**Q: 实验需要多久？**
A: 全数据集（1353样本，7个方法）约96小时（4天）。Self-Aware-MRAG部分约12.4小时。

**Q: 如何停止实验？**
A: 
```bash
pkill -f "run_all_baselines_100samples.py"
```

---

**📌 提醒**: 本手册持续更新，每次重大变更后请更新"最后更新"时间和"最新变更"部分！

**🔒 重要**: 本文件不能删除、不能归档、不能移动！

